#!/bin/zsh

open_scheme()
{
    result=`find $SCHEME_HOUSE_DIR -name '*.terminal' | peco`
    open $result
}

get_scheme()
{
    echo "not implemented"
}

save_scheme()
{
    selected=`defaults read com.apple.Terminal 'Window Settings' | grep name | tr -d ' ' | sed -e 's/name=//' | sed -e 's/;//' | peco`
    defaults write com.apple.Terminal "Default Window Settings" -string $selected
    defaults write com.apple.Terminal "Startup Window Settings" -string $selected
    echo "set ${selected}. PLZ restart terminal"
}

load_list()
{
    echo "----- schemes list -----"
    defaults read com.apple.Terminal 'Window Settings' | grep name | tr -d ' ' | sed -e 's/name=//' 
}

set_font_name()
{
    echo "not implemented"
}

set_font_size()
{
    echo -n "font size? " 
    read size
    osascript -e "tell application \"Terminal\" to set the font size of window 1 to $size"
    echo "DONE"
}

# define variables
SCHEME_HOUSE_DIR=$HOME/.schemes-house
SCHEME_SETTING=$HOME/.schemes-setting

## check dir exists
if ! [ -e $SCHEME_HOUSE_DIR ]; then
    touch $SCHEME_HOUSE_DIR
    echo 'make .schemes-setting file'
fi

if ! [ -e $SCHEME_SETTING ]; then
    mkdir $SCHEME_SETTING
    echo 'make .schemes-setting dir'
fi

## select function
COMMANDS=("open" "get" "save" "list" "font_name" "font_size")
SELECTED_COMMAND=`for item in ${COMMANDS[@]}; do echo $item; done | peco`
if [ $SELECTED_COMMAND = "open" ]; then
    open_scheme
elif [ $SELECTED_COMMAND = "get" ]; then
    get_scheme
elif [ $SELECTED_COMMAND = "save" ]; then
    save_scheme
elif [ $SELECTED_COMMAND = "list" ]; then
    load_list
elif [ $SELECTED_COMMAND = "font_name" ]; then
    set_font_name
elif [ $SELECTED_COMMAND = "font_size" ]; then
    set_font_size
fi

## get exists .terminal and peco

# TERM_PROFILE=$result
# echo $TERM_PROFILE
# CURRENT_PROFILE="$(defaults read com.apple.Terminal 'Default Window Settings')"
# FILE_NAME_EXT=${result##**/}
# FILE_NAME=${FILE_NAME_EXT%.*}

## むう。挙動がよくわからんねぇ。変なschemeがデフォルトにセットされたりしておる
# if [ "${CURRENT_PROFILE}" != "${TERM_PROFILE}" ]; then
#     defaults write com.apple.Terminal "Default Window Settings" -string "$FILE_NAME"
#     defaults write com.apple.Terminal "Startup Window Settings" -string "$FILE_NAME"
# fi

function set_font
{
    osascript -e "tell application \"Terminal\" to set the font name of window 1 to \"$1\""
}

set_font "Menleo" 12
